---
import { getCollection, type CollectionEntry } from "astro:content";
import "../styles/home.css";
import "../styles/posts.css";
import "../styles/page-transitions.css";
import Navigation from "../components/Navigation.astro";
import Footer from "../components/Footer.astro";
import { siteConfig } from "../config/site";
import { postImages, defaultPostImage } from "../config/posts-images";

// Get all posts from content collection
const allPosts = (await getCollection("posts")) as CollectionEntry<"posts">[];

// Convert date format from "6/27/2025" to "June 27, 2025"
function formatDate(dateString: string): string {
  const [month, day, year] = dateString.split("/");
  const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

// Extract plain text from markdown content
function extractExcerptFromMarkdown(
  content: string,
  maxLength: number = 300
): string {
  // Remove markdown syntax
  let text = content
    .replace(/^#+\s+/gm, "") // Remove headers
    .replace(/\[([^\]]+)\]\([^\)]+\)/g, "$1") // Remove links, keep text
    .replace(/\*\*([^\*]+)\*\*/g, "$1") // Remove bold
    .replace(/\*([^\*]+)\*/g, "$1") // Remove italic
    .replace(/`([^`]+)`/g, "$1") // Remove inline code
    .replace(/```[\s\S]*?```/g, "") // Remove code blocks
    .replace(/\n+/g, " ") // Replace newlines with space
    .trim();

  // Get first maxLength characters
  if (text.length > maxLength) {
    text = text.substring(0, maxLength);
    // Try to cut at a sentence boundary
    const lastPeriod = text.lastIndexOf(".");
    const lastSpace = text.lastIndexOf(" ");
    const cutPoint = lastPeriod > maxLength * 0.7 ? lastPeriod + 1 : lastSpace;
    if (cutPoint > maxLength * 0.7) {
      text = text.substring(0, cutPoint);
    }
    text += "...";
  }

  return text;
}

// Transform content collection posts to match the expected format
const posts = await Promise.all(
  allPosts.map(async (post: any) => {
    // Get slug from post - try multiple fallbacks
    // In Astro, post.slug should be available, but if not, extract from id
    let slug = post.slug;
    if (!slug && post.id) {
      // Extract slug from id (e.g., "posts/my-post.md" -> "my-post")
      slug = post.id.split("/").pop()?.replace(/\.md$/, "") || "";
    }
    if (!slug) {
      console.warn("Post missing slug:", post);
    }

    // Try to get excerpt from frontmatter first
    let excerpt = post.data.excerpt;

    // If no excerpt in frontmatter, generate a default excerpt from title
    if (!excerpt) {
      // In Astro 6.0, post.body is no longer available
      // Use a default excerpt based on title or provide a generic message
      excerpt = `Read more about ${post.data.title}...`;
    }

    // Get image from frontmatter, fallback to mapping, then default
    const image = post.data.image || postImages[slug] || defaultPostImage;

    return {
      id: slug,
      date: formatDate(post.data.date),
      title: post.data.title,
      tags: post.data.tags || [],
      excerpt: excerpt,
      readTime: post.data.readTime || "5 min read",
      slug: slug,
      image: image,
    };
  })
);

// Sort by date (newest first)
posts.sort((a, b) => {
  return new Date(b.date).getTime() - new Date(a.date).getTime();
});

// Group posts by date
const groupedPosts = posts.reduce(
  (acc, post) => {
    if (!acc[post.date]) {
      acc[post.date] = [];
    }
    acc[post.date].push(post);
    return acc;
  },
  {} as Record<string, typeof posts>
);

// Extract all unique tags from posts
const allTags = Array.from(
  new Set(posts.flatMap((post) => post.tags.map((tag: string) => tag)))
).sort();
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content={Astro.generator} />
    <title>Evidencias</title>
    <script>
      // Disable browser scroll restoration and ensure page starts at top
      if ("scrollRestoration" in history) {
        history.scrollRestoration = "manual";
      }
      // Immediately scroll to top on page load
      window.scrollTo(0, 0);
    </script>
  </head>
  <body>
    <Navigation />

    <main class="posts-page">
      <div class="posts-container page-content">
        <div class="posts-header posts-header-animate">
          <h1 class="posts-title">{siteConfig.posts.title}</h1>
          <p class="posts-subtitle">{siteConfig.posts.subtitle}</p>
        </div>



        <div class="tags-filter posts-content-animate">
          <span class="tags-label">Filter by tags:</span>
          <div class="tags-list">
            {
              allTags.map((tag) => (
                <button
                  class="tag-button"
                  data-tag={tag.toLowerCase().replace(/\s+/g, "-")}
                >
                  {tag}
                </button>
              ))
            }
          </div>
        </div>

        <div class="posts-list posts-content-animate">
          {
            Object.entries(groupedPosts).map(([date, datePosts]) => (
              <div class="date-group" data-date={date}>
                <h2 class="date-header">{date}</h2>
                <div class="date-card">
                  {datePosts.map((post) => (
                    <article class="post-item" data-post-id={post.slug}>
                      <div class="post-summary">
                        <div class="title-icon-left" />
                        <h3 class="post-title">
                          <a
                            href={`/posts/${post.slug}`}
                            class="post-title-link"
                          >
                            {post.title}
                          </a>
                          <div class="title-icon-right" />
                        </h3>
                        {post.tags.length > 0 && (
                          <div class="post-tags">
                            {post.tags.map((tag: string) => (
                              <span class="post-tag">{tag}</span>
                            ))}
                          </div>
                        )}
                        <button
                          class="post-toggle"
                          aria-label="Toggle post details"
                        >
                          <span class="post-arrow">↓</span>
                        </button>
                      </div>
                      <div class="post-details">
                        <div class="post-content-wrapper">
                          <div class="post-excerpt-wrapper">
                            <p class="post-excerpt">{post.excerpt}</p>
                            <div class="post-footer">
                              <a
                                href={`/posts/${post.slug}`}
                                class="post-read-more"
                              >
                                Read more →
                              </a>
                              <span class="post-read-time">
                                ⏱️ {post.readTime}
                              </span>
                            </div>
                          </div>
                          <div class="post-image-container">
                            <img
                              src={post.image}
                              alt={post.title}
                              class="post-image"
                            />
                          </div>
                        </div>
                      </div>
                    </article>
                  ))}
                </div>
              </div>
            ))
          }
        </div>
      </div>
    </main>

    <Footer />
  </body>
</html>

<script>
  // Ensure scroll position is at top after DOM loads
  document.addEventListener("DOMContentLoaded", () => {
    window.scrollTo(0, 0);
    setTimeout(() => {
      window.scrollTo(0, 0);
    }, 0);
  });
  // Also ensure on page show (handles back/forward navigation)
  window.addEventListener("pageshow", (event) => {
    if (event.persisted) {
      window.scrollTo(0, 0);
    }
  });

  // Initialize page transition animations
  document.addEventListener("DOMContentLoaded", () => {
    // Trigger page content animation
    const pageContent = document.querySelector(".page-content");
    if (pageContent) {
      requestAnimationFrame(() => {
        pageContent.classList.add("visible");
      });
    }

    // Trigger header animation
    const header = document.querySelector(".posts-header-animate");
    if (header) {
      requestAnimationFrame(() => {
        header.classList.add("visible");
      });
    }

    // Trigger content animations
    const contentElements = document.querySelectorAll(".posts-content-animate");
    contentElements.forEach((element) => {
      requestAnimationFrame(() => {
        element.classList.add("visible");
      });
    });
  });

  // Expand/collapse behavior
  const postToggles = document.querySelectorAll(".post-toggle");
  const postSummaries = document.querySelectorAll(".post-summary");

  postToggles.forEach((toggle) => {
    toggle.addEventListener("click", (e) => {
      e.stopPropagation();
      const postItem = toggle.closest(".post-item");
      if (postItem) {
        postItem.classList.toggle("expanded");
        const arrow = toggle.querySelector(".post-arrow");
        if (arrow) {
          arrow.textContent = postItem.classList.contains("expanded")
            ? "↑"
            : "↓";
        }
      }
    });
  });

  // Click row to expand/collapse
  postSummaries.forEach((summary) => {
    summary.addEventListener("click", (e) => {
      // Ignore clicks on the title link
      if ((e.target as HTMLElement).closest(".post-title-link")) {
        return;
      }
      // Ignore clicks on the toggle button
      if ((e.target as HTMLElement).closest(".post-toggle")) {
        return;
      }

      const postItem = summary.closest(".post-item");
      if (postItem) {
        postItem.classList.toggle("expanded");
        const arrow = postItem.querySelector(".post-arrow");
        if (arrow) {
          arrow.textContent = postItem.classList.contains("expanded")
            ? "↑"
            : "↓";
        }
      }
    });
  });

  // Search filter
  const searchInput = document.getElementById("search-input");
  if (searchInput) {
    searchInput.addEventListener("input", (e) => {
      const searchTerm = (e.target as HTMLInputElement).value.toLowerCase();
      const postItems = document.querySelectorAll(".post-item");

      postItems.forEach((item) => {
        const title =
          item.querySelector(".post-title a")?.textContent?.toLowerCase() || "";
        const excerpt =
          item.querySelector(".post-excerpt")?.textContent?.toLowerCase() || "";

        if (title.includes(searchTerm) || excerpt.includes(searchTerm)) {
          (item as HTMLElement).style.display = "block";
        } else {
          (item as HTMLElement).style.display = "none";
        }
      });

      // Update date group visibility
      const dateGroups = document.querySelectorAll(".date-group");
      dateGroups.forEach((dateGroup) => {
        const visibleItems = dateGroup.querySelectorAll(
          '.post-item[style*="block"], .post-item:not([style*="none"])'
        );
        (dateGroup as HTMLElement).style.display =
          visibleItems.length > 0 ? "block" : "none";
      });
    });
  }

  // Tag filtering (multi-select)
  const tagButtons = document.querySelectorAll(".tag-button");
  const dateGroups = document.querySelectorAll(".date-group");

  function applyFilters() {
    // Collect active tags
    const activeTags = Array.from(tagButtons)
      .filter((btn) => btn.classList.contains("active"))
      .map((btn) => btn.getAttribute("data-tag"))
      .filter((tag): tag is string => tag !== null);

    // If no active tags, show everything
    if (activeTags.length === 0) {
      dateGroups.forEach((dateGroup) => {
        const postItems = dateGroup.querySelectorAll(".post-item");
        postItems.forEach((item) => {
          (item as HTMLElement).style.display = "block";
        });
        (dateGroup as HTMLElement).style.display = "block";
      });
      return;
    }

    // Filter posts: show those matching any active tag
    dateGroups.forEach((dateGroup) => {
      const postItems = dateGroup.querySelectorAll(".post-item");
      let hasVisiblePosts = false;

      postItems.forEach((item) => {
        const postTags = Array.from(item.querySelectorAll(".post-tag")).map(
          (tag) => tag.textContent?.toLowerCase().replace(/\s+/g, "-") || ""
        );

        // Check if post has any active tag
        const hasMatchingTag = activeTags.some((activeTag) =>
          postTags.includes(activeTag)
        );

        if (hasMatchingTag) {
          (item as HTMLElement).style.display = "block";
          hasVisiblePosts = true;
        } else {
          (item as HTMLElement).style.display = "none";
        }
      });

      // Hide date group when no visible posts
      (dateGroup as HTMLElement).style.display = hasVisiblePosts
        ? "block"
        : "none";
    });
  }

  tagButtons.forEach((button) => {
    button.addEventListener("click", () => {
      // Toggle active state
      button.classList.toggle("active");

      // Apply filters
      applyFilters();
    });
  });
</script>
